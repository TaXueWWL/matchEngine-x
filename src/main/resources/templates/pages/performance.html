<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- Performance Monitoring Content Fragment -->
<div th:fragment="content" id="performance-content">
    <style>
        /* æ€§èƒ½ç›‘æ§é¡µé¢ä¸“ç”¨æ ·å¼ - æ”¯æŒä¸»é¢˜åˆ‡æ¢ */
        .performance-card {
            border-left: 4px solid #007bff !important;
            transition: all 0.3s ease;
            background-color: var(--bs-card-bg, #ffffff) !important;
            color: var(--bs-body-color, #212529) !important;
        }

        .performance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff !important;
        }

        .metric-label {
            color: var(--bs-secondary, #6c757d) !important;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-healthy { background-color: #28a745 !important; }
        .status-warning { background-color: #ffc107 !important; }
        .status-error { background-color: #dc3545 !important; }
        .status-unknown { background-color: #6c757d !important; }

        .performance-chart {
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-radius: 8px;
            color: white !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn {
            background: linear-gradient(45deg, #667eea, #764ba2) !important;
            border: none !important;
            color: white !important;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            color: white !important;
        }

        .loading-spinner {
            display: none;
        }

        .table-performance {
            font-family: 'Courier New', monospace;
            background-color: var(--bs-table-bg, transparent) !important;
            color: var(--bs-body-color, #212529) !important;
        }

        /* ç¡®ä¿åœ¨é»‘è‰²ä¸»é¢˜ä¸‹ä¹Ÿèƒ½æ­£å¸¸æ˜¾ç¤º */
        body.dark-theme .performance-card {
            background-color: #181A20 !important;
            color: #EAECEF !important;
            border-color: #2B2F36 !important;
        }

        body.dark-theme .performance-card .card-header {
            background-color: #1E2026 !important;
            color: #EAECEF !important;
            border-bottom-color: #2B2F36 !important;
        }

        body.dark-theme .performance-card .card-body {
            background-color: #181A20 !important;
            color: #EAECEF !important;
        }

        body.dark-theme .metric-label {
            color: #9CA3AF !important;
        }

        body.dark-theme .table-performance {
            background-color: transparent !important;
            color: #EAECEF !important;
        }

        body.dark-theme .table-performance th {
            background-color: #2B2F36 !important;
            color: #EAECEF !important;
            border-color: #2B2F36 !important;
        }

        body.dark-theme .table-performance td {
            background-color: #181A20 !important;
            color: #EAECEF !important;
            border-color: #2B2F36 !important;
        }
    </style>

    <!-- é¡µé¢æ ‡é¢˜å’Œåˆ·æ–°æŒ‰é’® -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-tachometer-alt text-primary"></i> æ€§èƒ½ç›‘æ§</h2>
            <p class="text-muted">å®æ—¶ç›‘æ§WebSocketæ¨é€å’ŒDisruptoræ€§èƒ½æŒ‡æ ‡</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-primary refresh-btn" onclick="refreshAllData()">
                <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
            </button>
            <div class="loading-spinner text-primary mt-2">
                <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
            </div>
        </div>
    </div>

    <!-- ç³»ç»Ÿå¥åº·çŠ¶æ€ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card performance-card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-heartbeat text-success"></i> ç³»ç»Ÿå¥åº·çŠ¶æ€</h5>
                </div>
                <div class="card-body">
                    <div class="row" id="health-status">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <span class="status-indicator status-unknown"></span>
                                <span>æ•´ä½“çŠ¶æ€: <strong id="overall-status">æ£€æŸ¥ä¸­...</strong></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <span class="status-indicator status-unknown"></span>
                                <span>Disruptor: <strong id="disruptor-status">æ£€æŸ¥ä¸­...</strong></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <span class="status-indicator status-unknown"></span>
                                <span>æ’®åˆå¼•æ“: <strong id="matching-engine-status">æ£€æŸ¥ä¸­...</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Disruptor æ€§èƒ½æŒ‡æ ‡ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card performance-card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-rocket text-info"></i> Disruptor æ€§èƒ½</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="text-center">
                                <div class="metric-value" id="ring-buffer-cursor">-</div>
                                <div class="metric-label">å½“å‰æ¸¸æ ‡ä½ç½®</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center">
                                <div class="metric-value" id="ring-buffer-capacity">-</div>
                                <div class="metric-label">å‰©ä½™å®¹é‡</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>é…ç½®ä¿¡æ¯:</strong><br>
                            ç¯å½¢ç¼“å†²åŒºå¤§å°: <span class="badge bg-primary">8192</span>
                            ç­‰å¾…ç­–ç•¥: <span class="badge bg-info">BlockingWaitStrategy</span>
                            ç”Ÿäº§è€…æ¨¡å¼: <span class="badge bg-success">MULTI</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card performance-card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-chart-line text-success"></i> çº¿ç¨‹æ± çŠ¶æ€</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="text-center">
                                <div class="metric-value" id="thread-pool-active">-</div>
                                <div class="metric-label">æ´»è·ƒçº¿ç¨‹</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center">
                                <div class="metric-value" id="thread-pool-queue">-</div>
                                <div class="metric-label">é˜Ÿåˆ—å¤§å°</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            çº¿ç¨‹æ± å¤§å°: <span id="thread-pool-size" class="badge bg-primary">-</span>
                            å·²å®Œæˆä»»åŠ¡: <span id="thread-pool-completed" class="badge bg-success">-</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WebSocketæ¨é€ç»Ÿè®¡ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card performance-card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-broadcast-tower text-warning"></i> WebSocket æ¨é€ç»Ÿè®¡</h5>
                </div>
                <div class="card-body">
                    <div class="performance-chart" id="websocket-chart">
                        <div class="text-center">
                            <i class="fas fa-chart-area fa-3x mb-3"></i>
                            <h4>å®æ—¶æ¨é€ç›‘æ§</h4>
                            <p>Disruptor + WebSocket è¶…ä½å»¶è¿Ÿæ¨é€</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card performance-card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-list-alt text-secondary"></i> è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-performance">
                            <thead class="table-dark">
                                <tr>
                                    <th>æŒ‡æ ‡</th>
                                    <th>å½“å‰å€¼</th>
                                    <th>æè¿°</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="performance-details">
                                <tr>
                                    <td>ç³»ç»Ÿè¿è¡Œæ—¶é—´</td>
                                    <td id="system-uptime">è®¡ç®—ä¸­...</td>
                                    <td>æœåŠ¡å¯åŠ¨åˆ°ç°åœ¨çš„æ—¶é—´</td>
                                    <td><span class="badge bg-success">æ­£å¸¸</span></td>
                                </tr>
                                <tr>
                                    <td>Disruptor çŠ¶æ€</td>
                                    <td id="disruptor-detailed-status">æ£€æŸ¥ä¸­...</td>
                                    <td>ç¯å½¢ç¼“å†²åŒºè¿è¡ŒçŠ¶æ€</td>
                                    <td><span class="badge bg-primary">ç›‘æ§ä¸­</span></td>
                                </tr>
                                <tr>
                                    <td>WebSocket è¿æ¥</td>
                                    <td id="websocket-connections">è·å–ä¸­...</td>
                                    <td>å½“å‰æ´»è·ƒçš„WebSocketè¿æ¥æ•°</td>
                                    <td><span class="badge bg-info">æ´»è·ƒ</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æœ€è¿‘æ›´æ–°æ—¶é—´ -->
    <div class="row">
        <div class="col-12">
            <div class="text-center text-muted">
                <small>
                    <i class="fas fa-clock"></i>
                    æœ€åæ›´æ–°: <span id="last-update-time">-</span>
                    | è‡ªåŠ¨åˆ·æ–°: <span id="auto-refresh-status" class="text-success">å·²å¼€å¯</span>
                </small>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let autoRefreshInterval;
        let isRefreshing = false;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Performance monitoring page loaded');
            console.log('DOM elements check:');
            console.log('overall-status:', document.getElementById('overall-status'));
            console.log('disruptor-status:', document.getElementById('disruptor-status'));
            console.log('matching-engine-status:', document.getElementById('matching-engine-status'));

            // å…ˆæ˜¾ç¤ºä¸€äº›åŸºæœ¬ä¿¡æ¯
            updateLastUpdateTime();

            const overallStatus = document.getElementById('overall-status');
            const disruptorStatus = document.getElementById('disruptor-status');
            const matchingEngineStatus = document.getElementById('matching-engine-status');

            if (overallStatus) overallStatus.textContent = 'åˆå§‹åŒ–ä¸­...';
            if (disruptorStatus) disruptorStatus.textContent = 'æ£€æŸ¥ä¸­...';
            if (matchingEngineStatus) matchingEngineStatus.textContent = 'æ£€æŸ¥ä¸­...';

            // ç«‹å³æµ‹è¯•ä¸€ä¸ªç®€å•çš„æ›´æ–°
            console.log('ğŸ”§ Testing basic updates...');
            setTimeout(() => {
                if (overallStatus) overallStatus.textContent = 'æµ‹è¯•æ›´æ–°æˆåŠŸ';
            }, 100);

            // å»¶è¿ŸåŠ è½½æ•°æ®ï¼Œé¿å…é˜»å¡é¡µé¢æ¸²æŸ“
            setTimeout(() => {
                console.log('ğŸ“Š Starting data refresh...');
                refreshAllData();
                startAutoRefresh();
            }, 1000);
        });

        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAllData() {
            if (isRefreshing) return;

            isRefreshing = true;
            showLoading(true);

            try {
                console.log('Refreshing all performance data...');

                // å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ®
                const [healthData, disruptorData, websocketData] = await Promise.all([
                    fetchHealthData(),
                    fetchDisruptorData(),
                    fetchWebSocketData()
                ]);

                // æ›´æ–°ç•Œé¢
                updateHealthStatus(healthData);
                updateDisruptorMetrics(disruptorData);
                updateWebSocketStats(websocketData);
                updateLastUpdateTime();

                console.log('Performance data refreshed successfully');

            } catch (error) {
                console.error('Error refreshing performance data:', error);
                showError('åˆ·æ–°æ•°æ®æ—¶å‡ºé”™: ' + error.message);
            } finally {
                isRefreshing = false;
                showLoading(false);
            }
        }

        // è·å–å¥åº·çŠ¶æ€æ•°æ®
        async function fetchHealthData() {
            console.log('ğŸ¥ Fetching health data...');
            try {
                const response = await fetch('/api/performance/health');
                console.log('Health response status:', response.status);
                if (!response.ok) throw new Error(`è·å–å¥åº·çŠ¶æ€å¤±è´¥: ${response.status}`);
                const data = await response.json();
                console.log('Health data:', data);
                return data;
            } catch (error) {
                console.error('Health fetch error:', error);
                throw error;
            }
        }

        // è·å–Disruptoræ•°æ®
        async function fetchDisruptorData() {
            console.log('ğŸš€ Fetching disruptor data...');
            try {
                const response = await fetch('/api/performance/disruptor');
                console.log('Disruptor response status:', response.status);
                if (!response.ok) throw new Error(`è·å–Disruptoræ•°æ®å¤±è´¥: ${response.status}`);
                const data = await response.json();
                console.log('Disruptor data:', data);
                return data;
            } catch (error) {
                console.error('Disruptor fetch error:', error);
                throw error;
            }
        }

        // è·å–WebSocketæ¨é€æ•°æ®
        async function fetchWebSocketData() {
            console.log('ğŸ”Œ Fetching websocket data...');
            try {
                const response = await fetch('/api/performance/websocket-push');
                console.log('WebSocket response status:', response.status);
                if (!response.ok) throw new Error(`è·å–WebSocketæ•°æ®å¤±è´¥: ${response.status}`);
                const data = await response.json();
                console.log('WebSocket data:', data);
                return data;
            } catch (error) {
                console.error('WebSocket fetch error:', error);
                throw error;
            }
        }

        // æ›´æ–°å¥åº·çŠ¶æ€
        function updateHealthStatus(data) {
            console.log('ğŸ“Š Updating health status with data:', data);
            const overallStatus = document.getElementById('overall-status');
            const disruptorStatus = document.getElementById('disruptor-status');
            const matchingEngineStatus = document.getElementById('matching-engine-status');

            console.log('DOM elements for health:', {
                overallStatus: overallStatus,
                disruptorStatus: disruptorStatus,
                matchingEngineStatus: matchingEngineStatus
            });

            if (data && data.status) {
                console.log('Setting health status texts...');
                if (overallStatus) overallStatus.textContent = getStatusText(data.status);
                if (disruptorStatus) disruptorStatus.textContent = getStatusText(data.disruptor);
                if (matchingEngineStatus) matchingEngineStatus.textContent = getStatusText(data.matchingEngine);

                // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                updateStatusIndicators(data);
                console.log('âœ… Health status updated successfully');
            } else {
                console.warn('âš ï¸ No data or status field in health data');
            }
        }

        // æ›´æ–°DisruptoræŒ‡æ ‡
        function updateDisruptorMetrics(data) {
            if (data && data.disruptorStats) {
                const stats = parseDisruptorStats(data.disruptorStats);
                document.getElementById('ring-buffer-cursor').textContent = stats.cursor || '-';
                document.getElementById('ring-buffer-capacity').textContent = stats.capacity || '-';
            }
        }

        // æ›´æ–°WebSocketç»Ÿè®¡
        function updateWebSocketStats(data) {
            if (data && data.overall) {
                const stats = parseThreadPoolStats(data.overall);
                document.getElementById('thread-pool-active').textContent = stats.active || '-';
                document.getElementById('thread-pool-queue').textContent = stats.queue || '-';
                document.getElementById('thread-pool-size').textContent = stats.poolSize || '-';
                document.getElementById('thread-pool-completed').textContent = stats.completed || '-';
            }
        }

        // è§£æDisruptorç»Ÿè®¡ä¿¡æ¯
        function parseDisruptorStats(statsString) {
            const stats = {};
            if (typeof statsString === 'string') {
                const cursorMatch = statsString.match(/Cursor: (\d+)/);
                const capacityMatch = statsString.match(/Remaining Capacity: (\d+)/);

                stats.cursor = cursorMatch ? cursorMatch[1] : '-';
                stats.capacity = capacityMatch ? capacityMatch[1] : '-';
            }
            return stats;
        }

        // è§£æçº¿ç¨‹æ± ç»Ÿè®¡ä¿¡æ¯
        function parseThreadPoolStats(statsString) {
            const stats = {};
            if (typeof statsString === 'string') {
                const activeMatch = statsString.match(/Active: (\d+)/);
                const poolSizeMatch = statsString.match(/Pool: (\d+)/);
                const queueMatch = statsString.match(/Queue: (\d+)/);
                const completedMatch = statsString.match(/Completed: (\d+)/);

                stats.active = activeMatch ? activeMatch[1] : '-';
                stats.poolSize = poolSizeMatch ? poolSizeMatch[1] : '-';
                stats.queue = queueMatch ? queueMatch[1] : '-';
                stats.completed = completedMatch ? completedMatch[1] : '-';
            }
            return stats;
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            switch(status) {
                case 'healthy': return 'å¥åº·';
                case 'running': return 'è¿è¡Œä¸­';
                case 'degraded': return 'é™çº§';
                case 'error': return 'é”™è¯¯';
                case 'not_available': return 'ä¸å¯ç”¨';
                default: return 'æœªçŸ¥';
            }
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatusIndicators(data) {
            const indicators = document.querySelectorAll('.status-indicator');
            indicators.forEach((indicator, index) => {
                indicator.className = 'status-indicator';

                let status;
                switch(index) {
                    case 0: status = data.status; break;
                    case 1: status = data.disruptor; break;
                    case 2: status = data.matchingEngine; break;
                }

                if (status === 'healthy' || status === 'running') {
                    indicator.classList.add('status-healthy');
                } else if (status === 'degraded') {
                    indicator.classList.add('status-warning');
                } else if (status === 'error') {
                    indicator.classList.add('status-error');
                } else {
                    indicator.classList.add('status-unknown');
                }
            });
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(show) {
            const spinner = document.querySelector('.loading-spinner');
            if (spinner) {
                spinner.style.display = show ? 'block' : 'none';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            console.error(message);
            // è¿™é‡Œå¯ä»¥æ·»åŠ toasté€šçŸ¥æˆ–å…¶ä»–é”™è¯¯æ˜¾ç¤º
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update-time').textContent = now.toLocaleTimeString();
        }

        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            autoRefreshInterval = setInterval(() => {
                console.log('Auto-refreshing performance data...');
                refreshAllData();
            }, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡

            document.getElementById('auto-refresh-status').textContent = 'å·²å¼€å¯';
        }

        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            document.getElementById('auto-refresh-status').textContent = 'å·²å…³é—­';
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</div>

</html>