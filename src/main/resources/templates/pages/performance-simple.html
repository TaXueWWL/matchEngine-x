<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- Simple Performance Monitoring Content Fragment -->
<div th:fragment="content">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="fas fa-tachometer-alt text-primary"></i> æ€§èƒ½ç›‘æ§</h2>
                <p class="text-muted">å®æ—¶ç›‘æ§WebSocketæ¨é€å’ŒDisruptoræ€§èƒ½æŒ‡æ ‡</p>
                <button class="btn btn-primary mb-4" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
                </button>
            </div>
        </div>

        <!-- ç³»ç»Ÿå¥åº·çŠ¶æ€ -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-heartbeat text-success"></i> ç³»ç»ŸçŠ¶æ€</h5>
                    </div>
                    <div class="card-body">
                        <h3 id="overall-status" class="text-primary">åŠ è½½ä¸­...</h3>
                        <small class="text-muted">æ•´ä½“å¥åº·çŠ¶æ€</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-rocket text-info"></i> Disruptor</h5>
                    </div>
                    <div class="card-body">
                        <h3 id="disruptor-status" class="text-info">åŠ è½½ä¸­...</h3>
                        <small class="text-muted">æ¶ˆæ¯é˜Ÿåˆ—çŠ¶æ€</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs text-warning"></i> æ’®åˆå¼•æ“</h5>
                    </div>
                    <div class="card-body">
                        <h3 id="matching-engine-status" class="text-warning">åŠ è½½ä¸­...</h3>
                        <small class="text-muted">å¼•æ“è¿è¡ŒçŠ¶æ€</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ€§èƒ½æŒ‡æ ‡ -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Disruptor æŒ‡æ ‡</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h4 id="cursor-position" class="text-success">-</h4>
                                <small>å½“å‰æ¸¸æ ‡</small>
                            </div>
                            <div class="col-6">
                                <h4 id="remaining-capacity" class="text-warning">-</h4>
                                <small>å‰©ä½™å®¹é‡</small>
                            </div>
                        </div>
                        <hr>
                        <small class="text-muted">
                            ç¼“å†²åŒºå¤§å°: <span class="badge bg-primary">8192</span>
                            ç­‰å¾…ç­–ç•¥: <span class="badge bg-info">Blocking</span>
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-server"></i> çº¿ç¨‹æ± çŠ¶æ€</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h4 id="active-threads" class="text-danger">-</h4>
                                <small>æ´»è·ƒçº¿ç¨‹</small>
                            </div>
                            <div class="col-6">
                                <h4 id="queue-size" class="text-info">-</h4>
                                <small>é˜Ÿåˆ—å¤§å°</small>
                            </div>
                        </div>
                        <hr>
                        <small class="text-muted">
                            çº¿ç¨‹æ± : <span id="pool-size" class="badge bg-secondary">-</span>
                            å·²å®Œæˆ: <span id="completed-tasks" class="badge bg-success">-</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†ä¿¡æ¯ -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> è¯¦ç»†ä¿¡æ¯</h5>
                    </div>
                    <div class="card-body">
                        <div id="detailed-info">
                            <p>æ­£åœ¨åŠ è½½è¯¦ç»†ä¿¡æ¯...</p>
                        </div>
                        <small class="text-muted">
                            æœ€åæ›´æ–°: <span id="last-update">-</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç®€å•çš„å…¨å±€å˜é‡
        let refreshInterval;

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        window.addEventListener('load', function() {
            console.log('âœ… Performance monitoring page loaded successfully');

            // ç«‹å³åˆ·æ–°ä¸€æ¬¡æ•°æ®
            refreshData();

            // è®¾ç½®è‡ªåŠ¨åˆ·æ–° (5ç§’)
            refreshInterval = setInterval(refreshData, 5000);

            console.log('ğŸ”„ Auto-refresh started (5 seconds interval)');
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });

        // ä¸»è¦çš„æ•°æ®åˆ·æ–°å‡½æ•°
        function refreshData() {
            console.log('ğŸ”„ Starting data refresh...');

            // æ›´æ–°æ—¶é—´æˆ³
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

            // å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ®
            Promise.all([
                loadHealthData(),
                loadDisruptorData(),
                loadWebSocketData()
            ]).then(() => {
                console.log('âœ… All data refreshed successfully');
            }).catch(error => {
                console.error('âŒ Error refreshing data:', error);
                showError('æ•°æ®åˆ·æ–°å¤±è´¥: ' + error.message);
            });
        }

        // åŠ è½½å¥åº·æ•°æ®
        async function loadHealthData() {
            try {
                console.log('ğŸ“¡ Loading health data...');
                const response = await fetch('/api/performance/health');
                const data = await response.json();

                console.log('Health data received:', data);

                // æ›´æ–°çŠ¶æ€
                updateElementText('overall-status', getStatusText(data.status));
                updateElementText('disruptor-status', getStatusText(data.disruptor));
                updateElementText('matching-engine-status', getStatusText(data.matchingEngine));

            } catch (error) {
                console.error('Health data error:', error);
                updateElementText('overall-status', 'Error');
                updateElementText('disruptor-status', 'Error');
                updateElementText('matching-engine-status', 'Error');
            }
        }

        // åŠ è½½Disruptoræ•°æ®
        async function loadDisruptorData() {
            try {
                console.log('ğŸš€ Loading disruptor data...');
                const response = await fetch('/api/performance/disruptor');
                const data = await response.json();

                console.log('Disruptor data received:', data);

                if (data.disruptorStats) {
                    const stats = parseDisruptorStats(data.disruptorStats);
                    updateElementText('cursor-position', stats.cursor || '-');
                    updateElementText('remaining-capacity', stats.capacity || '-');
                }

            } catch (error) {
                console.error('Disruptor data error:', error);
                updateElementText('cursor-position', 'Error');
                updateElementText('remaining-capacity', 'Error');
            }
        }

        // åŠ è½½WebSocketæ•°æ®
        async function loadWebSocketData() {
            try {
                console.log('ğŸ”Œ Loading websocket data...');
                const response = await fetch('/api/performance/websocket-push');
                const data = await response.json();

                console.log('WebSocket data received:', data);

                if (data.overall) {
                    const stats = parseThreadPoolStats(data.overall);
                    updateElementText('active-threads', stats.active || '-');
                    updateElementText('queue-size', stats.queue || '-');
                    updateElementText('pool-size', stats.poolSize || '-');
                    updateElementText('completed-tasks', stats.completed || '-');
                }

                // æ›´æ–°è¯¦ç»†ä¿¡æ¯
                let detailHtml = '<div class="row">';
                detailHtml += '<div class="col-md-6"><strong>Disruptor:</strong><br><code>' + (data.disruptor || 'N/A') + '</code></div>';
                detailHtml += '<div class="col-md-6"><strong>ThreadPool:</strong><br><code>' + (data.overall || 'N/A') + '</code></div>';
                detailHtml += '</div>';

                document.getElementById('detailed-info').innerHTML = detailHtml;

            } catch (error) {
                console.error('WebSocket data error:', error);
                updateElementText('active-threads', 'Error');
                updateElementText('queue-size', 'Error');
                document.getElementById('detailed-info').innerHTML = '<p class="text-danger">åŠ è½½å¤±è´¥: ' + error.message + '</p>';
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨æ›´æ–°å…ƒç´ æ–‡æœ¬
        function updateElementText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            } else {
                console.warn('Element not found:', elementId);
            }
        }

        // è§£æDisruptorç»Ÿè®¡ä¿¡æ¯
        function parseDisruptorStats(statsString) {
            const stats = {};
            if (typeof statsString === 'string') {
                const cursorMatch = statsString.match(/Cursor: (\d+)/);
                const capacityMatch = statsString.match(/Remaining Capacity: (\d+)/);

                stats.cursor = cursorMatch ? cursorMatch[1] : null;
                stats.capacity = capacityMatch ? capacityMatch[1] : null;
            }
            return stats;
        }

        // è§£æçº¿ç¨‹æ± ç»Ÿè®¡ä¿¡æ¯
        function parseThreadPoolStats(statsString) {
            const stats = {};
            if (typeof statsString === 'string') {
                const activeMatch = statsString.match(/Active: (\d+)/);
                const poolSizeMatch = statsString.match(/Pool: (\d+)/);
                const queueMatch = statsString.match(/Queue: (\d+)/);
                const completedMatch = statsString.match(/Completed: (\d+)/);

                stats.active = activeMatch ? activeMatch[1] : null;
                stats.poolSize = poolSizeMatch ? poolSizeMatch[1] : null;
                stats.queue = queueMatch ? queueMatch[1] : null;
                stats.completed = completedMatch ? completedMatch[1] : null;
            }
            return stats;
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'healthy': 'å¥åº·',
                'running': 'è¿è¡Œä¸­',
                'degraded': 'é™çº§',
                'error': 'é”™è¯¯',
                'unhealthy': 'ä¸å¥åº·'
            };
            return statusMap[status] || status || 'æœªçŸ¥';
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            console.error(message);
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ˜¾ç¤º
        }
    </script>
</div>

<!-- Empty scripts fragment to satisfy base template -->
<div th:fragment="scripts"></div>

</html>