<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- Simple Performance Monitoring Content Fragment -->
<div th:fragment="content">
    <!-- 页面标题 -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="fas fa-tachometer-alt text-primary"></i> 性能监控</h2>
                <p class="text-muted">实时监控WebSocket推送和Disruptor性能指标</p>
                <button class="btn btn-primary mb-4" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> 刷新数据
                </button>
            </div>
        </div>

        <!-- 系统健康状态 -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-heartbeat text-success"></i> 系统状态</h5>
                    </div>
                    <div class="card-body">
                        <h3 id="overall-status" class="text-primary">加载中...</h3>
                        <small class="text-muted">整体健康状态</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-rocket text-info"></i> Disruptor</h5>
                    </div>
                    <div class="card-body">
                        <h3 id="disruptor-status" class="text-info">加载中...</h3>
                        <small class="text-muted">消息队列状态</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs text-warning"></i> 撮合引擎</h5>
                    </div>
                    <div class="card-body">
                        <h3 id="matching-engine-status" class="text-warning">加载中...</h3>
                        <small class="text-muted">引擎运行状态</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 性能指标 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Disruptor 指标</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h4 id="cursor-position" class="text-success">-</h4>
                                <small>当前游标</small>
                            </div>
                            <div class="col-6">
                                <h4 id="remaining-capacity" class="text-warning">-</h4>
                                <small>剩余容量</small>
                            </div>
                        </div>
                        <hr>
                        <small class="text-muted">
                            缓冲区大小: <span class="badge bg-primary">8192</span>
                            等待策略: <span class="badge bg-info">Blocking</span>
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-server"></i> 线程池状态</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h4 id="active-threads" class="text-danger">-</h4>
                                <small>活跃线程</small>
                            </div>
                            <div class="col-6">
                                <h4 id="queue-size" class="text-info">-</h4>
                                <small>队列大小</small>
                            </div>
                        </div>
                        <hr>
                        <small class="text-muted">
                            线程池: <span id="pool-size" class="badge bg-secondary">-</span>
                            已完成: <span id="completed-tasks" class="badge bg-success">-</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 详细信息 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> 详细信息</h5>
                    </div>
                    <div class="card-body">
                        <div id="detailed-info">
                            <p>正在加载详细信息...</p>
                        </div>
                        <small class="text-muted">
                            最后更新: <span id="last-update">-</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 简单的全局变量
        let refreshInterval;

        // 页面加载完成后执行
        window.addEventListener('load', function() {
            console.log('✅ Performance monitoring page loaded successfully');

            // 立即刷新一次数据
            refreshData();

            // 设置自动刷新 (5秒)
            refreshInterval = setInterval(refreshData, 5000);

            console.log('🔄 Auto-refresh started (5 seconds interval)');
        });

        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });

        // 主要的数据刷新函数
        function refreshData() {
            console.log('🔄 Starting data refresh...');

            // 更新时间戳
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

            // 并行获取所有数据
            Promise.all([
                loadHealthData(),
                loadDisruptorData(),
                loadWebSocketData()
            ]).then(() => {
                console.log('✅ All data refreshed successfully');
            }).catch(error => {
                console.error('❌ Error refreshing data:', error);
                showError('数据刷新失败: ' + error.message);
            });
        }

        // 加载健康数据
        async function loadHealthData() {
            try {
                console.log('📡 Loading health data...');
                const response = await fetch('/api/performance/health');
                const data = await response.json();

                console.log('Health data received:', data);

                // 更新状态
                updateElementText('overall-status', getStatusText(data.status));
                updateElementText('disruptor-status', getStatusText(data.disruptor));
                updateElementText('matching-engine-status', getStatusText(data.matchingEngine));

            } catch (error) {
                console.error('Health data error:', error);
                updateElementText('overall-status', 'Error');
                updateElementText('disruptor-status', 'Error');
                updateElementText('matching-engine-status', 'Error');
            }
        }

        // 加载Disruptor数据
        async function loadDisruptorData() {
            try {
                console.log('🚀 Loading disruptor data...');
                const response = await fetch('/api/performance/disruptor');
                const data = await response.json();

                console.log('Disruptor data received:', data);

                if (data.disruptorStats) {
                    const stats = parseDisruptorStats(data.disruptorStats);
                    updateElementText('cursor-position', stats.cursor || '-');
                    updateElementText('remaining-capacity', stats.capacity || '-');
                }

            } catch (error) {
                console.error('Disruptor data error:', error);
                updateElementText('cursor-position', 'Error');
                updateElementText('remaining-capacity', 'Error');
            }
        }

        // 加载WebSocket数据
        async function loadWebSocketData() {
            try {
                console.log('🔌 Loading websocket data...');
                const response = await fetch('/api/performance/websocket-push');
                const data = await response.json();

                console.log('WebSocket data received:', data);

                if (data.overall) {
                    const stats = parseThreadPoolStats(data.overall);
                    updateElementText('active-threads', stats.active || '-');
                    updateElementText('queue-size', stats.queue || '-');
                    updateElementText('pool-size', stats.poolSize || '-');
                    updateElementText('completed-tasks', stats.completed || '-');
                }

                // 更新详细信息
                let detailHtml = '<div class="row">';
                detailHtml += '<div class="col-md-6"><strong>Disruptor:</strong><br><code>' + (data.disruptor || 'N/A') + '</code></div>';
                detailHtml += '<div class="col-md-6"><strong>ThreadPool:</strong><br><code>' + (data.overall || 'N/A') + '</code></div>';
                detailHtml += '</div>';

                document.getElementById('detailed-info').innerHTML = detailHtml;

            } catch (error) {
                console.error('WebSocket data error:', error);
                updateElementText('active-threads', 'Error');
                updateElementText('queue-size', 'Error');
                document.getElementById('detailed-info').innerHTML = '<p class="text-danger">加载失败: ' + error.message + '</p>';
            }
        }

        // 辅助函数：安全更新元素文本
        function updateElementText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            } else {
                console.warn('Element not found:', elementId);
            }
        }

        // 解析Disruptor统计信息
        function parseDisruptorStats(statsString) {
            const stats = {};
            if (typeof statsString === 'string') {
                const cursorMatch = statsString.match(/Cursor: (\d+)/);
                const capacityMatch = statsString.match(/Remaining Capacity: (\d+)/);

                stats.cursor = cursorMatch ? cursorMatch[1] : null;
                stats.capacity = capacityMatch ? capacityMatch[1] : null;
            }
            return stats;
        }

        // 解析线程池统计信息
        function parseThreadPoolStats(statsString) {
            const stats = {};
            if (typeof statsString === 'string') {
                const activeMatch = statsString.match(/Active: (\d+)/);
                const poolSizeMatch = statsString.match(/Pool: (\d+)/);
                const queueMatch = statsString.match(/Queue: (\d+)/);
                const completedMatch = statsString.match(/Completed: (\d+)/);

                stats.active = activeMatch ? activeMatch[1] : null;
                stats.poolSize = poolSizeMatch ? poolSizeMatch[1] : null;
                stats.queue = queueMatch ? queueMatch[1] : null;
                stats.completed = completedMatch ? completedMatch[1] : null;
            }
            return stats;
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'healthy': '健康',
                'running': '运行中',
                'degraded': '降级',
                'error': '错误',
                'unhealthy': '不健康'
            };
            return statusMap[status] || status || '未知';
        }

        // 显示错误信息
        function showError(message) {
            console.error(message);
            // 可以在这里添加用户友好的错误显示
        }
    </script>
</div>

<!-- Empty scripts fragment to satisfy base template -->
<div th:fragment="scripts"></div>

</html>