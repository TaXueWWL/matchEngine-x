<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- Minimal Performance Monitoring Content Fragment -->
<div th:fragment="content">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="fas fa-tachometer-alt"></i> æ€§èƒ½ç›‘æ§</h2>
                <p class="text-muted">å®æ—¶ç›‘æ§WebSocketæ¨é€å’ŒDisruptoræ€§èƒ½æŒ‡æ ‡</p>
                <button class="btn btn-primary mb-4" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
                </button>
            </div>
        </div>

        <!-- ç³»ç»Ÿå¥åº·çŠ¶æ€ -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>ç³»ç»ŸçŠ¶æ€</h5>
                    </div>
                    <div class="card-body">
                        <h3 id="overall-status" class="text-primary">åŠ è½½ä¸­...</h3>
                        <small class="text-muted">æ•´ä½“å¥åº·çŠ¶æ€</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Disruptor</h5>
                    </div>
                    <div class="card-body">
                        <h3 id="disruptor-status" class="text-info">åŠ è½½ä¸­...</h3>
                        <small class="text-muted">æ¶ˆæ¯é˜Ÿåˆ—çŠ¶æ€</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>æ’®åˆå¼•æ“</h5>
                    </div>
                    <div class="card-body">
                        <h3 id="matching-engine-status" class="text-warning">åŠ è½½ä¸­...</h3>
                        <small class="text-muted">å¼•æ“è¿è¡ŒçŠ¶æ€</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ€§èƒ½æŒ‡æ ‡ -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Disruptor æŒ‡æ ‡</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h4 id="cursor-position" class="text-success">-</h4>
                                <small>å½“å‰æ¸¸æ ‡</small>
                            </div>
                            <div class="col-6">
                                <h4 id="remaining-capacity" class="text-warning">-</h4>
                                <small>å‰©ä½™å®¹é‡</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>çº¿ç¨‹æ± çŠ¶æ€</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h4 id="active-threads" class="text-danger">-</h4>
                                <small>æ´»è·ƒçº¿ç¨‹</small>
                            </div>
                            <div class="col-6">
                                <h4 id="queue-size" class="text-info">-</h4>
                                <small>é˜Ÿåˆ—å¤§å°</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€ä¿¡æ¯ -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>è¿è¡ŒçŠ¶æ€</h5>
                    </div>
                    <div class="card-body">
                        <p>æœ€åæ›´æ–°: <span id="last-update" class="badge bg-secondary">-</span></p>
                        <p>APIçŠ¶æ€: <span id="api-status" class="badge bg-success">æ­£å¸¸</span></p>
                        <div id="detailed-info">
                            <p class="text-muted">ç­‰å¾…æ•°æ®åŠ è½½...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Minimal scripts fragment -->
<div th:fragment="scripts">
    <script>
        console.log('ğŸš€ Minimal performance monitoring loaded');

        // é¡µé¢åŠ è½½åè‡ªåŠ¨åˆ·æ–°
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âœ… DOM loaded, starting data refresh...');
            refreshData();

            // è®¾ç½®è‡ªåŠ¨åˆ·æ–° (æ¯5ç§’)
            setInterval(refreshData, 5000);
        });

        // ä¸»è¦çš„æ•°æ®åˆ·æ–°å‡½æ•°
        function refreshData() {
            console.log('ğŸ”„ Refreshing data...');

            // æ›´æ–°æ—¶é—´æˆ³
            const now = new Date().toLocaleTimeString();
            document.getElementById('last-update').textContent = now;

            // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
            Promise.all([
                loadHealthData(),
                loadDisruptorData(),
                loadWebSocketData()
            ]).then(function() {
                console.log('âœ… All data loaded');
                document.getElementById('api-status').textContent = 'æ­£å¸¸';
                document.getElementById('api-status').className = 'badge bg-success';
            }).catch(function(error) {
                console.error('âŒ Data loading failed:', error);
                document.getElementById('api-status').textContent = 'é”™è¯¯';
                document.getElementById('api-status').className = 'badge bg-danger';
            });
        }

        // åŠ è½½å¥åº·æ•°æ®
        function loadHealthData() {
            return fetch('/api/performance/health')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    console.log('Health data:', data);

                    document.getElementById('overall-status').textContent = getStatusText(data.status);
                    document.getElementById('disruptor-status').textContent = getStatusText(data.disruptor);
                    document.getElementById('matching-engine-status').textContent = getStatusText(data.matchingEngine);
                })
                .catch(function(error) {
                    console.error('Health API error:', error);
                    document.getElementById('overall-status').textContent = 'é”™è¯¯';
                    document.getElementById('disruptor-status').textContent = 'é”™è¯¯';
                    document.getElementById('matching-engine-status').textContent = 'é”™è¯¯';
                });
        }

        // åŠ è½½Disruptoræ•°æ®
        function loadDisruptorData() {
            return fetch('/api/performance/disruptor')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    console.log('Disruptor data:', data);

                    if (data.disruptorStats) {
                        const stats = parseDisruptorStats(data.disruptorStats);
                        document.getElementById('cursor-position').textContent = stats.cursor || '-';
                        document.getElementById('remaining-capacity').textContent = stats.capacity || '-';
                    }
                })
                .catch(function(error) {
                    console.error('Disruptor API error:', error);
                    document.getElementById('cursor-position').textContent = 'é”™è¯¯';
                    document.getElementById('remaining-capacity').textContent = 'é”™è¯¯';
                });
        }

        // åŠ è½½WebSocketæ•°æ®
        function loadWebSocketData() {
            return fetch('/api/performance/websocket-push')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    console.log('WebSocket data:', data);

                    if (data.overall) {
                        const stats = parseThreadPoolStats(data.overall);
                        document.getElementById('active-threads').textContent = stats.active || '-';
                        document.getElementById('queue-size').textContent = stats.queue || '-';
                    }

                    // æ›´æ–°è¯¦ç»†ä¿¡æ¯
                    let html = '<div class="row">';
                    html += '<div class="col-12"><strong>è¯¦ç»†ç»Ÿè®¡:</strong></div>';
                    html += '<div class="col-12"><small><code>' + (data.overall || 'N/A') + '</code></small></div>';
                    html += '</div>';

                    document.getElementById('detailed-info').innerHTML = html;
                })
                .catch(function(error) {
                    console.error('WebSocket API error:', error);
                    document.getElementById('active-threads').textContent = 'é”™è¯¯';
                    document.getElementById('queue-size').textContent = 'é”™è¯¯';
                    document.getElementById('detailed-info').innerHTML = '<p class="text-danger">åŠ è½½å¤±è´¥: ' + error.message + '</p>';
                });
        }

        // è§£æDisruptorç»Ÿè®¡ä¿¡æ¯
        function parseDisruptorStats(statsString) {
            const stats = {};
            if (typeof statsString === 'string') {
                const cursorMatch = statsString.match(/Cursor: (\d+)/);
                const capacityMatch = statsString.match(/Remaining Capacity: (\d+)/);
                stats.cursor = cursorMatch ? cursorMatch[1] : null;
                stats.capacity = capacityMatch ? capacityMatch[1] : null;
            }
            return stats;
        }

        // è§£æçº¿ç¨‹æ± ç»Ÿè®¡ä¿¡æ¯
        function parseThreadPoolStats(statsString) {
            const stats = {};
            if (typeof statsString === 'string') {
                const activeMatch = statsString.match(/Active: (\d+)/);
                const queueMatch = statsString.match(/Queue: (\d+)/);
                stats.active = activeMatch ? activeMatch[1] : null;
                stats.queue = queueMatch ? queueMatch[1] : null;
            }
            return stats;
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'healthy': 'å¥åº·',
                'running': 'è¿è¡Œä¸­',
                'degraded': 'é™çº§',
                'error': 'é”™è¯¯',
                'unhealthy': 'ä¸å¥åº·'
            };
            return statusMap[status] || status || 'æœªçŸ¥';
        }
    </script>
</div>

</html>